import{r as d,j as a,L as Z,a as B}from"./app-DM5lWH7w.js";import{A as ee,B as ae}from"./Breadcrumb-DriWI8JK.js";import{B as P}from"./button-D_azY7HU.js";import{I as v}from"./input-C9qzQYtQ.js";import{C as te,a as se,b as re,c as ne}from"./card-DjyVTpSh.js";import{B as y}from"./badge-D2PfSuDc.js";import{D as ie,C as T,L as $,P as le}from"./react-beautiful-dnd.esm-CceVe5Va.js";import de from"./OrderDialog-D4wcxNZs.js";import{S as oe}from"./search-DZ4Pfh-R.js";import{C as E}from"./calendar-D95ocz5F.js";import{E as ce}from"./eye-CSKhNZ0e.js";import{f as ge}from"./format-D9VrrLpI.js";import"./shopping-cart-CZJG6TeG.js";import"./index-H22tECQ6.js";import"./utils-De8wPBUk.js";import"./star-NL1IKTr_.js";import"./truck-PZjfZowP.js";import"./shopping-bag-D-8jhm6x.js";import"./users-Bg5QJiIM.js";import"./user-DrHZ__g_.js";import"./index-ijvaBZ7a.js";import"./tiny-invariant-BaFNuDhB.js";import"./dialog-_yQDYPAD.js";import"./index-v8iwHGUi.js";import"./index-B4EdUvDt.js";import"./x-ToVJaZZw.js";import"./table-BGT-YAZs.js";import"./printer-Br_SKlEC.js";import"./vi-DmPgEhae.js";function Ae(){const[x,u]=d.useState([]),[w,_]=d.useState(!0),[p,G]=d.useState(""),[f,M]=d.useState(""),[b,K]=d.useState(""),[c,C]=d.useState({current_page:1,per_page:30,total:0,last_page:1}),[R,A]=d.useState(null),[H,D]=d.useState(!1),j={packed:"Đã đóng gói",shipping:"Đang giao hàng",delivered:"Giao hàng thành công",shipping_failed:"Giao không thành công"},N={completed:"Hoàn thành"},I={...j,...N},S={new:"bg-blue-100 text-blue-800",processing:"bg-green-100 text-green-800",cancelled:"bg-red-100 text-red-800",preparing:"bg-yellow-100 text-yellow-800",packed:"bg-purple-100 text-purple-800",shipping:"bg-indigo-100 text-indigo-800",delivered:"bg-emerald-100 text-emerald-800",shipping_failed:"bg-rose-100 text-rose-800",completed:"bg-teal-100 text-teal-800"},V={pending:"Chờ thanh toán",paid:"Đã thanh toán",refunded:"Đã hoàn tiền",failed:"Thanh toán thất bại",awaiting_payment:"Đang chờ thanh toán"},F={pending:"bg-yellow-100 text-yellow-800",paid:"bg-green-100 text-green-800",refunded:"bg-purple-100 text-purple-800",failed:"bg-red-100 text-red-800"},O=async()=>{try{_(!0);const e={};p&&p.trim()!==""&&(e.search=p.trim()),f&&(e.from_date=f),b&&(e.to_date=b),e.page=c.current_page,e.per_page=c.per_page,e.order_status=Object.keys(I).join(",");const t=await B.get("/api/v1/orders",{params:e});t.data&&t.data.data&&(u(t.data.data.data),C({current_page:t.data.data.current_page,per_page:t.data.data.per_page,total:t.data.data.total,last_page:t.data.data.last_page}))}catch(e){console.error("Lỗi khi tải đơn hàng:",e),u([])}finally{_(!1)}};d.useEffect(()=>{const e=setTimeout(()=>{O()},300);return()=>clearTimeout(e)},[p,f,b,c.current_page]);const z=async(e,t,s)=>{var l,n;try{return(await B.put(`/admin/orders/${e}/status`,{status:t})).data.status==="success"?(O(),alert("Trạng thái đơn hàng đã được cập nhật thành công"),!0):!1}catch(r){console.error("Lỗi khi cập nhật trạng thái đơn hàng:",r),alert(((n=(l=r.response)==null?void 0:l.data)==null?void 0:n.message)||"Lỗi khi cập nhật trạng thái đơn hàng");const i=[...x],o=i.findIndex(h=>h.order_id.toString()===e);return o!==-1&&(i[o]={...i[o],order_status:s},u(i)),!1}},q=async e=>{const{destination:t,source:s,draggableId:l}=e;if(!(!t||t.droppableId===s.droppableId&&t.index===s.index)&&t.droppableId!==s.droppableId){const n=l,r=t.droppableId,i=s.droppableId;if(i==="shipping"&&r==="delivered"){const m=x.find(Y=>Y.order_id.toString()===n);let L="Bạn có xác nhận đã giao hàng thành công?";if(m&&m.payment_method==="cod"&&(L=`Bạn có xác nhận đã giao hàng thành công và đã nhận đủ ${X(m.total_amount)} từ khách hàng?`),!window.confirm(L))return}if(i==="delivered"&&r==="completed"&&!window.confirm("Bạn có xác nhận đơn hàng đã hoàn thành và không cần xử lý thêm?"))return;const o=[...x],h=o.findIndex(m=>m.order_id.toString()===n);h!==-1&&(o[h]={...o[h],order_status:r},u(o)),await z(n,r,i)}},J=e=>{A(e),D(!0)},Q=()=>{D(!1)},U=[{label:"Giao hàng",href:"/admin/orders"}],W=e=>e?ge(new Date(e),"dd/MM/yyyy"):"",X=e=>new Intl.NumberFormat("vi-VN",{style:"currency",currency:"VND"}).format(e),g=x.reduce((e,t)=>{const s=t.order_status;return e[s]||(e[s]=[]),e[s].push(t),e},Object.keys(I).reduce((e,t)=>({...e,[t]:[]}),{})),k=({order:e,index:t,isReadOnly:s})=>a.jsx(le,{draggableId:e.order_id.toString(),index:t,isDragDisabled:s,children:(l,n)=>{var r;return a.jsx("div",{ref:l.innerRef,...l.draggableProps,...l.dragHandleProps,className:`mb-4 ${n.isDragging?"opacity-75":""}`,children:a.jsxs(te,{className:`hover:shadow-md transition-shadow ${s?"border-l-4 border-l-gray-400":""}`,children:[a.jsxs(se,{className:"pb-2 flex flex-row justify-between items-center",children:[a.jsxs(re,{className:"text-sm font-semibold flex items-center",children:["#",e.order_id,s&&a.jsx($,{className:"h-3 w-3 ml-1 text-gray-500"})]}),a.jsx(y,{className:F[e.payment_status]||"bg-gray-100",children:V[e.payment_status]||e.payment_status})]}),a.jsxs(ne,{className:"pt-0",children:[a.jsxs("div",{className:"text-sm mb-2",children:[a.jsx("div",{className:"font-medium",children:((r=e.user)==null?void 0:r.name)||"Khách hàng"}),a.jsx("div",{className:"text-gray-500",children:W(e.order_date)})]}),a.jsx("div",{className:"flex justify-between items-center mt-2",children:a.jsxs(P,{variant:"outline",size:"sm",className:"text-blue-600 hover:text-blue-700",onClick:i=>{i.stopPropagation(),J(e.order_id)},children:[a.jsx(ce,{className:"h-4 w-4 mr-1"}),"Chi tiết"]})})]})]})})}},e.order_id);return a.jsxs(ee,{children:[a.jsx(Z,{title:"Giao hàng"}),a.jsxs("div",{className:"container mx-auto py-6 px-4",children:[a.jsx(ae,{items:U}),a.jsx("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6",children:a.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Giao hàng"})}),a.jsx("div",{className:"bg-white rounded-lg shadow overflow-hidden mb-6",children:a.jsxs("div",{className:"p-4 grid grid-cols-1 md:grid-cols-3 gap-4",children:[a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(oe,{className:"h-4 w-4 text-gray-500"}),a.jsx(v,{type:"text",placeholder:"Tìm kiếm đơn hàng...",value:p,onChange:e=>G(e.target.value),className:"w-full"})]}),a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(E,{className:"h-4 w-4 text-gray-500"}),a.jsx(v,{type:"date",value:f,onChange:e=>M(e.target.value),className:"w-full",placeholder:"Từ ngày"})]}),a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(E,{className:"h-4 w-4 text-gray-500"}),a.jsx(v,{type:"date",value:b,onChange:e=>K(e.target.value),className:"w-full",placeholder:"Đến ngày"})]})]})}),w?a.jsx("div",{className:"flex justify-center py-8",children:a.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"})}):a.jsx(ie,{onDragEnd:q,children:a.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-5 lg:grid-cols-5 gap-4",children:[Object.keys(j).map(e=>{var t;return a.jsxs("div",{className:"bg-gray-50 rounded-lg p-4",children:[a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h2",{className:"font-semibold text-gray-700",children:a.jsx("span",{className:`px-2 py-1 rounded-full ${S[e]}`,children:j[e]})}),a.jsx(y,{variant:"outline",className:"bg-white",children:((t=g[e])==null?void 0:t.length)||0})]}),a.jsx(T,{droppableId:e,children:(s,l)=>{var n;return a.jsxs("div",{ref:s.innerRef,...s.droppableProps,className:`space-y-2 overflow-y-auto max-h-[calc(100vh-250px)] min-h-64 p-2 rounded-lg ${l.isDraggingOver?"bg-gray-100":"bg-gray-50"}`,children:[((n=g[e])==null?void 0:n.length)===0?a.jsx("div",{className:"text-center py-8 text-gray-500 bg-white rounded-lg border border-dashed border-gray-300",children:"Không có đơn hàng nào"}):g[e].map((r,i)=>a.jsx(k,{order:r,index:i,isReadOnly:!1},r.order_id)),s.placeholder]})}})]},e)}),Object.keys(N).map(e=>{var t;return a.jsxs("div",{className:"bg-gray-50 rounded-lg p-4 relative",children:[a.jsx("div",{className:"absolute top-2 right-2",children:a.jsxs(y,{variant:"outline",className:"bg-gray-200 text-gray-700 flex items-center gap-1",children:[a.jsx($,{className:"h-3 w-3"})," Chỉ xem"]})}),a.jsxs("div",{className:"flex items-center justify-between mb-4",children:[a.jsx("h2",{className:"font-semibold text-gray-700",children:a.jsx("span",{className:`px-2 py-1 rounded-full ${S[e]}`,children:N[e]})}),a.jsx(y,{variant:"outline",className:"bg-white",children:((t=g[e])==null?void 0:t.length)||0})]}),a.jsx(T,{droppableId:e,isDropDisabled:!0,children:(s,l)=>{var n;return a.jsxs("div",{ref:s.innerRef,...s.droppableProps,className:"space-y-2 overflow-y-auto max-h-[calc(100vh-250px)] min-h-64 p-2 rounded-lg bg-gray-100 opacity-90",children:[((n=g[e])==null?void 0:n.length)===0?a.jsx("div",{className:"text-center py-8 text-gray-500 bg-white rounded-lg border border-dashed border-gray-300",children:"Không có đơn hàng nào"}):g[e].map((r,i)=>a.jsx(k,{order:r,index:i,isReadOnly:!0},r.order_id)),s.placeholder]})}})]},e)})]})}),!w&&c.last_page>1&&a.jsx("div",{className:"flex justify-center mt-6",children:a.jsx("div",{className:"flex gap-2",children:Array.from({length:c.last_page},(e,t)=>t+1).map(e=>a.jsx(P,{variant:c.current_page===e?"default":"outline",className:"w-10 h-10",onClick:()=>C(t=>({...t,current_page:e})),children:e},e))})}),a.jsx(de,{orderId:R,isOpen:H,onClose:Q})]})]})}export{Ae as default};
