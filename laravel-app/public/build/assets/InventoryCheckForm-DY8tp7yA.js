import{r,j as e,a as S}from"./app-DM5lWH7w.js";import{D as re,a as ne,b as ie,c as ce,d as le}from"./dialog-_yQDYPAD.js";import{B as u}from"./button-D_azY7HU.js";import{I as x}from"./input-C9qzQYtQ.js";import{L as w}from"./label-Dh85IkX1.js";import{T as oe}from"./textarea-V4QGxS2H.js";import{T as O,a as A,b as g,c as i,d as K,e as c}from"./table-BGT-YAZs.js";import{S as de,a as he,b as me,c as ue,d as Q}from"./select-lTbdTkTd.js";import{P as $}from"./plus-DECCMGFS.js";import{S as xe}from"./search-DZ4Pfh-R.js";import{X as pe}from"./x-ToVJaZZw.js";import{T as je}from"./trash-2-Dy2jXSrq.js";import{C as fe}from"./check-Ct5f1nwX.js";import{f as X}from"./format-D9VrrLpI.js";import"./index-v8iwHGUi.js";import"./utils-De8wPBUk.js";import"./index-ijvaBZ7a.js";import"./index-B4EdUvDt.js";import"./index-H22tECQ6.js";import"./index-BeqeRdpr.js";import"./index-o3Sz-yc3.js";function ze({inventoryCheck:l,onClose:T,onSuccess:q}){const[J,C]=r.useState(!0),[D,L]=r.useState(X(new Date,"yyyy-MM-dd")),[I,P]=r.useState(""),[d,p]=r.useState([]),[F,M]=r.useState("draft"),[ge,E]=r.useState(!1),[y,H]=r.useState(!1),[V,j]=r.useState(null),[N,U]=r.useState([]),[h,b]=r.useState(""),[R,f]=r.useState([]),[v,z]=r.useState(!1),[W,_]=r.useState(!1),Y=async()=>{try{E(!0);const s=await S.get("/api/v1/products/all");if(s.data){const t=Array.isArray(s.data)?s.data:s.data.data||[];U(t)}console.log("Danh sách sản phẩm:",N)}catch(s){console.error("Lỗi khi tải danh sách sản phẩm:",s),j("Không thể tải danh sách sản phẩm. Vui lòng thử lại sau.")}finally{E(!1)}};r.useEffect(()=>{l&&(L(X(new Date(l.check_date),"yyyy-MM-dd")),P(l.note||""),M(l.status||"draft"),p(l.details||[])),Y()},[l]),r.useEffect(()=>{if(!h||h.length<2){f([]),_(!1);return}_(!0);const s=setTimeout(()=>{const t=N.filter(n=>n.name.toLowerCase().includes(h.toLowerCase())||n.brand.toLowerCase().includes(h.toLowerCase()));f(t),_(!1)},300);return()=>clearTimeout(s)},[h,N]);const B=()=>{z(!v),v||(b(""),f([]))},Z=s=>{if(d.find(a=>a.product_id===s.product_id)){alert(`Sản phẩm "${s.name}" đã có trong danh sách kiểm kê`);return}const n={product_id:s.product_id,product:s,system_quantity:s.stock_quantity||0,actual_quantity:s.stock_quantity||0,difference:0,note:""};p([...d,n]),z(!1),b(""),f([])},ee=s=>{p(d.filter(t=>t.product_id!==s))},k=(s,t,n)=>{const a=d.map(o=>{if(o.product_id===s){const m={...o,[t]:n};if(t==="system_quantity"||t==="actual_quantity"){const te=t==="system_quantity"?n:o.system_quantity,ae=t==="actual_quantity"?n:o.actual_quantity;m.difference=ae-te}return m}return o});p(a)},se=async s=>{var t,n;if(s.preventDefault(),d.length===0){j("Vui lòng thêm ít nhất một sản phẩm vào phiếu kiểm kê");return}try{H(!0),j(null);const a={check_date:D,status:F,note:I,details:d.map(m=>({product_id:m.product_id,system_quantity:parseInt(m.system_quantity)||0,actual_quantity:parseInt(m.actual_quantity)||0,note:m.note}))};let o;l?o=await S.put(`/admin/inventory-checks/${l.check_id}`,a):o=await S.post("/admin/inventory-checks",a),o.data.status==="success"&&(G(),q&&q(o.data.data))}catch(a){console.error("Lỗi khi lưu phiếu kiểm kê:",a),j(((n=(t=a.response)==null?void 0:t.data)==null?void 0:n.message)||"Đã xảy ra lỗi khi lưu phiếu kiểm kê. Vui lòng thử lại sau.")}finally{H(!1)}},G=()=>{C(!1),T&&T()};return e.jsx(re,{open:J,onOpenChange:C,children:e.jsxs(ne,{className:"sm:max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(ie,{children:e.jsx(ce,{children:l?"Chỉnh sửa phiếu kiểm kê":"Tạo phiếu kiểm kê mới"})}),e.jsxs("form",{onSubmit:se,children:[V&&e.jsx("div",{className:"bg-red-50 border border-red-200 text-red-700 rounded-md p-3 mb-4",children:V}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"check_date",children:"Ngày kiểm kê"}),e.jsx(x,{id:"check_date",type:"date",value:D,onChange:s=>L(s.target.value),required:!0})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(w,{htmlFor:"status",children:"Trạng thái"}),e.jsxs(de,{value:F,onValueChange:M,children:[e.jsx(he,{children:e.jsx(me,{placeholder:"Chọn trạng thái"})}),e.jsxs(ue,{children:[e.jsx(Q,{value:"draft",children:"Nháp"}),e.jsx(Q,{value:"completed",children:"Hoàn thành"})]})]})]})]}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsx(w,{htmlFor:"note",children:"Ghi chú"}),e.jsx(oe,{id:"note",value:I,onChange:s=>P(s.target.value),placeholder:"Nhập ghi chú (nếu có)",rows:3})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-medium",children:"Danh sách sản phẩm kiểm kê"}),e.jsxs(u,{type:"button",variant:"outline",onClick:B,className:"flex items-center gap-1",children:[e.jsx($,{className:"h-4 w-4"}),"Thêm sản phẩm"]})]}),v&&e.jsxs("div",{className:"border rounded-md p-4 mb-4 bg-gray-50",children:[e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsxs("div",{className:"relative flex-grow",children:[e.jsx(xe,{className:"absolute left-2 top-2.5 h-4 w-4 text-gray-400"}),e.jsx(x,{type:"text",placeholder:"Tìm kiếm sản phẩm theo tên hoặc mã...",value:h,onChange:s=>b(s.target.value),className:"pl-8"})]}),e.jsx(u,{type:"button",variant:"ghost",onClick:B,size:"icon",children:e.jsx(pe,{className:"h-4 w-4"})})]}),W?e.jsx("div",{className:"text-center py-4",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-gray-900 mx-auto"})}):R.length>0?e.jsx("div",{className:"max-h-60 overflow-y-auto",children:e.jsxs(O,{children:[e.jsx(A,{children:e.jsxs(g,{children:[e.jsx(i,{children:"Mã"}),e.jsx(i,{children:"Tên sản phẩm"}),e.jsx(i,{children:"Tồn kho"}),e.jsx(i,{})]})}),e.jsx(K,{children:R.map(s=>e.jsxs(g,{children:[e.jsx(c,{className:"font-medium",children:s.product_id}),e.jsx(c,{children:s.name}),e.jsx(c,{children:s.stock_quantity||0}),e.jsx(c,{children:e.jsx(u,{type:"button",variant:"ghost",size:"sm",onClick:()=>Z(s),children:e.jsx($,{className:"h-4 w-4"})})})]},s.product_id))})]})}):h.length>=2?e.jsx("div",{className:"text-center py-4 text-gray-500",children:"Không tìm thấy sản phẩm nào"}):e.jsx("div",{className:"text-center py-4 text-gray-500",children:"Nhập ít nhất 2 ký tự để tìm kiếm"})]}),d.length>0?e.jsx("div",{className:"border rounded-md overflow-hidden",children:e.jsxs(O,{children:[e.jsx(A,{children:e.jsxs(g,{children:[e.jsx(i,{children:"Mã"}),e.jsx(i,{children:"Tên sản phẩm"}),e.jsx(i,{className:"w-24",children:"SL hệ thống"}),e.jsx(i,{className:"w-24",children:"SL thực tế"}),e.jsx(i,{className:"w-24",children:"Chênh lệch"}),e.jsx(i,{className:"w-32",children:"Ghi chú"}),e.jsx(i,{className:"w-16"})]})}),e.jsx(K,{children:d.map(s=>{var t,n;return e.jsxs(g,{children:[e.jsx(c,{className:"font-medium",children:(t=s.product)==null?void 0:t.product_id}),e.jsx(c,{children:(n=s.product)==null?void 0:n.name}),e.jsx(c,{children:e.jsx(x,{type:"number",min:"0",value:s.system_quantity,onChange:a=>k(s.product_id,"system_quantity",parseInt(a.target.value)||0),className:"h-8"})}),e.jsx(c,{children:e.jsx(x,{type:"number",min:"0",value:s.actual_quantity,onChange:a=>k(s.product_id,"actual_quantity",parseInt(a.target.value)||0),className:"h-8"})}),e.jsx(c,{className:s.difference<0?"text-red-600":s.difference>0?"text-green-600":"",children:s.difference}),e.jsx(c,{children:e.jsx(x,{type:"text",value:s.note||"",onChange:a=>k(s.product_id,"note",a.target.value),placeholder:"Ghi chú",className:"h-8"})}),e.jsx(c,{children:e.jsx(u,{type:"button",variant:"ghost",size:"sm",onClick:()=>ee(s.product_id),children:e.jsx(je,{className:"h-4 w-4 text-red-500"})})})]},s.product_id)})})]})}):e.jsx("div",{className:"text-center py-6 border rounded-md text-gray-500",children:"Chưa có sản phẩm nào trong phiếu kiểm kê"})]}),e.jsxs(le,{className:"mt-6",children:[e.jsx(u,{type:"button",variant:"outline",onClick:G,disabled:y,children:"Hủy"}),e.jsx(u,{type:"submit",disabled:y||d.length===0,className:"ml-2",children:y?e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Đang lưu..."]}):e.jsxs(e.Fragment,{children:[e.jsx(fe,{className:"h-4 w-4 mr-2"}),l?"Cập nhật":"Tạo phiếu kiểm kê"]})})]})]})]})})}export{ze as default};
